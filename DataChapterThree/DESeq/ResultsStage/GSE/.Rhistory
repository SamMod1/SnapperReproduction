gene_universe=gene_universe,
title=module,
dotplot=dotplot,
alpha=alpha
))
}
kegg_enrichment <- function(
genes,
pathway=TRUE,
gene_universe=NULL,
title=NULL,
dotplot=TRUE,
alpha=ALPHA
) {
genes <- process_gene_list(genes)
deg_ids <- subset(GENE_MAPPING, GENE_MAPPING$Symbol %in% genes)$X.tax_id
if (!is.null(gene_universe)) {
gene_universe <- process_gene_list(gene_universe)
gene_universe <- subset(GENE_MAPPING, GENE_MAPPING$Symbol %in% gene_universe)$X.tax_id
}
if (pathway) {
enriched_kegg <- enrichKEGG(
gene = deg_ids,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = alpha,
universe = gene_universe
)
} else {
enriched_kegg <- enrichMKEGG(
gene = deg_ids,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = alpha,
universe = gene_universe
)
}
print(head(enriched_kegg))
if (nrow(enriched_kegg) == 0) {
return()
}
# Dotplot for DEGs
if (dotplot) {print(dotplot(enriched_kegg, showCategory=10))}
# Barplot for a specific module
print(barplot(enriched_kegg, showCategory=10, title=title))
return(enriched_kegg)
}
kegg_from_module <- function(
module,
memberships,
gene_universe=NULL,
pathway=TRUE,
dotplot=FALSE,
alpha=ALPHA
) {
genes <- rownames(subset(memberships, memberships$module_colors == module))
return(kegg_enrichment(
genes,
pathway=pathway,
gene_universe=gene_universe,
title=module,
dotplot=dotplot,
alpha=alpha
))
}
go_enrichment(genes)
go_enrichment(genes[p_adj <= 0.05])
go_enrichment(genes[ps <= 0.01])
go_enrichment(genes[ps <= 0.001])
go_enrichment(genes[ps <= 0.005])
go_enrichment(genes[ps <= 0.008])
sub <- subset(df, df$Gene_2 == 'lhb')
p_adj <- p.adjust(sub$p, method <- 'BH')
go_enrichment(sub$Gene_1[p_adj <= 0.05])
go_enrichment(sub$Gene_1[p_adj <= 0.01])
go_enrichment(sub$Gene_1[p_adj <= 0.001])
go_enrichment(sub$Gene_1[p_adj <= 0.005])
q()
if (!require("pacman")) install.packages("pacman")
pacman::p_load(clusterProfiler, stringr)
#GAF_FILE <- "C://Users//cfnsjm//Local Doccuments//PhD//Data//Genome//GO Databases//ChrAur_liftoff_go.gaf"
GAF_FILE <- "C:/Users/cfnsjm/Local Doccuments/PhD/Data/Genome/GO Databases/ChrAur_V1_go.gaf"
OBO_FILE <- "C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/go-basic.obo"
GENE_MAPPING_FILE <- "C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/joined_gene_info.csv"
ONTOLOGY_FILTER <- c('P', 'F', 'C') # P = Biological process, F = molecular function, C = cellular component
ALPHA <- 0.05
GENE_MAPPING <- read.csv(GENE_MAPPING_FILE)[,c('X.tax_id', 'Symbol')]
read_obo <- function(obo_file){
library(parallel)
if(.Platform$OS.type != "unix") cores <- 1
else cores <- detectCores()
obo <- readLines(obo_file)
obo <- gsub("\"", "", obo)
obo <- obo[seq(which(obo == "[Term]")[1], length(obo))]
start_element <- grep("^\\[.+\\]$", obo)
obo <- split(obo, rep.int(seq_along(start_element),
diff(c(start_element, length(obo) + 1))))
obo <- obo[sapply(obo, function(elem) elem[1] == "[Term]")]
obo <- mclapply(obo, function(x) x[x != "[Term]"], mc.cores = cores)
obo <- mclapply(obo, function(x) x[x != ""], mc.cores = cores)
result <- list()
obo <- mclapply(obo, function(x) regmatches(x, regexpr(": ", x), invert = TRUE), mc.cores = cores)
parse_vars <- function(x){
d <- list()
for(i in 1:length(x)){
if(x[[i]][[1]] %in% names(d)){
d[[x[[i]][[1]]]][length(d[[x[[i]][[1]]]])+1] <- x[[i]][[2]]
}
else
d[[x[[i]][[1]]]] <- x[[i]][[2]]
}
return(d)
}
for(i in 1:length(obo)){
result[[i]] <- parse_vars(obo[[i]])
}
return(structure(result, class = "ontology"))
}
# Load your custom GO annotations
ontology <- read_obo(OBO_FILE)
id <- c()
name <- c()
for (go in ontology) {
id <- append(id, go$id)
name <- append(name, go$name)
}
term_2_name <- data.frame(term = id, name = name)
go_annotations <- read.table(GAF_FILE, sep="\t", header=FALSE, quote="", comment.char="!")
go_annotations_filtered <- go_annotations[go_annotations$V9 %in% ONTOLOGY_FILTER, ]
colnames(go_annotations_filtered) <- c("DB", "GeneID", "Symbol", "Qualifier", "GO_ID", "Reference",
"Evidence_Code", "With_From", "Aspect", "Gene_Name",
"Gene_Synonym", "Type", "Taxon", "Date", "Assigned_By",
"Annot_Ext", "Gene_Product_Form_ID")
gene_universe_filtered <- unique(go_annotations_filtered$Symbol)
process_gene_list <- function(gene_list) {
gene_list <- str_replace_all(gene_list, 'gene-', '')
gene_list <- str_replace_all(gene_list, regex('_ChrAur[0-9]{0,9}'), '')
gene_list <- unique(gene_list)
gene_list <- gene_list[!is.na(gene_list)]
return(gene_list)
}
go_enrichment <- function(
genes,
gene_universe=NULL,
title=NULL,
dotplot=TRUE,
alpha=ALPHA
) {
genes <- process_gene_list(genes)
if (!is.null(gene_universe)) {
gene_universe <- process_gene_list(gene_universe)
gene_universe <- gene_universe[gene_universe %in% gene_universe_filtered]
} else {gene_universe <- gene_universe_filtered}
gene2go <- go_annotations_filtered[, c("GO_ID", 'Symbol')]
go_list <- split(gene2go$GO_ID, gene2go$Symbol)
go_id_to_name <- setNames(ontology$name, ontology$id)
ego_custom <- enricher(
genes,
TERM2GENE = gene2go,
pvalueCutoff = alpha,
TERM2NAME = term_2_name,
universe = gene_universe
)
print(head(ego_custom))
if (nrow(ego_custom) == 0) {
return()
}
# Dotplot for DEGs
if (dotplot) {print(dotplot(ego_custom, showCategory=10))}
# Barplot for a specific module
print(barplot(ego_custom, showCategory=10, title=title))
return(ego_custom)
}
go_from_module <- function(
module,
memberships,
gene_universe=NULL,
dotplot=FALSE,
alpha=ALPHA
) {
genes <- rownames(subset(memberships, memberships$module_colors == module))
return(go_enrichment(
genes,
gene_universe=gene_universe,
title=module,
dotplot=dotplot,
alpha=alpha
))
}
kegg_enrichment <- function(
genes,
pathway=TRUE,
gene_universe=NULL,
title=NULL,
dotplot=TRUE,
alpha=ALPHA
) {
genes <- process_gene_list(genes)
deg_ids <- subset(GENE_MAPPING, GENE_MAPPING$Symbol %in% genes)$X.tax_id
if (!is.null(gene_universe)) {
gene_universe <- process_gene_list(gene_universe)
gene_universe <- subset(GENE_MAPPING, GENE_MAPPING$Symbol %in% gene_universe)$X.tax_id
}
if (pathway) {
enriched_kegg <- enrichKEGG(
gene = deg_ids,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = alpha,
universe = gene_universe
)
} else {
enriched_kegg <- enrichMKEGG(
gene = deg_ids,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = alpha,
universe = gene_universe
)
}
print(head(enriched_kegg))
if (nrow(enriched_kegg) == 0) {
return()
}
# Dotplot for DEGs
if (dotplot) {print(dotplot(enriched_kegg, showCategory=10))}
# Barplot for a specific module
print(barplot(enriched_kegg, showCategory=10, title=title))
return(enriched_kegg)
}
kegg_from_module <- function(
module,
memberships,
gene_universe=NULL,
pathway=TRUE,
dotplot=FALSE,
alpha=ALPHA
) {
genes <- rownames(subset(memberships, memberships$module_colors == module))
return(kegg_enrichment(
genes,
pathway=pathway,
gene_universe=gene_universe,
title=module,
dotplot=dotplot,
alpha=alpha
))
}
enrichKEGG
?enrichKEGG
?ego_custom
?enricher
head(go_annotations_filtered)
gene2go <- go_annotations_filtered[, c("GO_ID", 'Symbol')]
nrow(gene2go)
head(gene2go)
length(unique(gene2go$GO_ID))
length(unique(gene2go$Symbol))
head(ontology)
head(term_to_name)
head(term_2_name)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # Only works when not running from source in RStudio
if (!require("pacman")) install.packages("pacman")
pacman::p_load(clusterProfiler, stringr, pathview, ggplot2)
if (!('enrichplot' %in% installed.packages())){BiocManager::install("enrichplot")}
library(enrichplot)
source("C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/go_enrichment.R") # Takes a little time to initialise but adds the function:
OUTPUT <- 'temp/GSE'
DEG_DATA_DIR <- 'C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/DESeq2/Output - Sex V Month Wald/Data'
GENE_MAPPING_FILE <- "C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/joined_gene_info.csv"
SEP <- '\t'
ALPHA <- 0.05
FOLD_CHANGE_CUTOFF <- 1
MIN_NDEG <- 10
SEED <- 1
process_gene_list <- function(gene_list) {
names(gene_list) <- str_replace_all(names(gene_list), regex('gene-'), '')
multiple_homologues_bool <- grepl('_ChrAur', names(gene_list), fixed = TRUE)
multiple_homologues <- names(gene_list)[multiple_homologues_bool]
multiple_homologues <- str_replace_all(multiple_homologues, regex('_ChrAur[0-9]{0,9}'), '')
multiple_homologues <- unique(multiple_homologues)
new_gene_list <- c()
for (homologue in multiple_homologues) {
gene_mean <- c(mean(gene_list[grepl(homologue, names(gene_list), fixed = TRUE)]))
names(gene_mean) <- c(homologue)
new_gene_list <- append(new_gene_list, gene_mean)
}
new_gene_list <- new_gene_list[
new_gene_list > FOLD_CHANGE_CUTOFF | new_gene_list < -FOLD_CHANGE_CUTOFF
]
new_gene_list <- append(new_gene_list, gene_list[!multiple_homologues_bool])
new_gene_list <- new_gene_list[!is.na(new_gene_list)]
return(new_gene_list)
}
gene_list_from_file <- function(file, dir=DEG_DATA_DIR, sep=SEP, universe=FALSE) {
path <- paste(dir, file, sep='/')
df <- read.csv(path, sep=sep)
if (universe) {return(df$gene)}
df <- subset(
df,
df$padj <= ALPHA &
(df$log2FoldChange > FOLD_CHANGE_CUTOFF | df$log2FoldChange < -FOLD_CHANGE_CUTOFF)
)
gene_list <- df$log2FoldChange
names(gene_list) <- df$gene
return(gene_list)
}
modify_duplicates <- function(gene_list) {
for (idx in which(duplicated(gene_list))) {
gene_list[idx] <- gene_list[idx] + 0.000001
}
if (any(duplicated(gene_list))) {
return(modify_duplicates(gene_list))
} else(return(gene_list))
}
if (!file.exists(OUTPUT)) {
dir.create(OUTPUT)
}
saved_wd <- getwd()
setwd(OUTPUT)
gene_mapping_df <- read.csv(GENE_MAPPING_FILE)[,c('X.tax_id', 'Symbol', 'description')]
gene_mapping_df <- gene_mapping_df[order(gene_mapping_df[,'Symbol']),]
gene_mapping_df <- gene_mapping_df[!duplicated(gene_mapping_df$Symbol),]
gene_mapping_df <- subset(gene_mapping_df, !substr(gene_mapping_df$description, 1, 15) == 'uncharacterized')
gene_mapping_df <- subset(gene_mapping_df, !gene_mapping_df$Symbol==gene_mapping_df$description)
gene_mapping <- gene_mapping_df$X.tax_id
names(gene_mapping) <- gene_mapping_df$Symbol
for (file in list.files(DEG_DATA_DIR)) {
print(file)
gene_list <- gene_list_from_file(file, DEG_DATA_DIR, sep=SEP)
go_list <- gene_list
gene_list <- process_gene_list(gene_list)
gene_list <- gene_list[names(gene_list)[names(gene_list) %in% names(gene_mapping)]]
gene_ids <- unname(gene_mapping[names(gene_list)])
names(gene_list) <- gene_ids
if (any(duplicated(gene_list))) {gene_list <- modify_duplicates(gene_list)}
if (any(duplicated(names(gene_list)))) {gene_list <- gene_list[!duplicated(names(gene_list))]}
gene_list <- gene_list[order(gene_list, decreasing=TRUE)]
if (length(gene_list) >= MIN_NDEG) {
go_list <- go_list[order(go_list, decreasing=TRUE)]
go <- gsea(
go_list,
'GO',
title = file,
return_plot = TRUE,
alpha = 0.05
)
gse_kegg <- gseKEGG(
gene_list,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = 0.05,
verbose = FALSE,
seed = SEED,
#universe=gene_list_from_file(file, DEG_DATA_DIR, universe=TRUE)
)
if (!file.exists(substr(file, 1, nchar(file)-4))) {
dir.create(substr(file, 1, nchar(file)-4))
}
setwd(substr(file, 1, nchar(file)-4))
if (!is.null(go)) {try(dev.off(), silent=TRUE); ggsave('GO.png', plot = go)}
gse_kegg@result <- subset(gse_kegg@result, gse_kegg@result$p.adjust < ALPHA)
if (nrow(gse_kegg@result) > 0) {
fig <- dotplot(gse_kegg, showCategory=10, split='.sign') + facet_grid(.~.sign)
ggsave('KEGG_dotplot.png', plot=fig)
}
if (
nrow(gse_kegg@result) > 0 &
length(list.files()) == 1
) {
for (idx in 1:nrow(gse_kegg@result)) {
row <- gse_kegg[idx,]
print(row$ID)
print(row$setSize)
try(path <- pathview(
gene.data = gene_list,
pathway.id = print(row$ID),
species = "dre",
limit = list(gene=5, cpd=5),
out.suffix = substr(file, 1, nchar(file) - 4)
), silent = TRUE)
}
}
setwd('..')
}
}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # Only works when not running from source in RStudio
if (!require("pacman")) install.packages("pacman")
pacman::p_load(clusterProfiler, stringr, pathview, ggplot2)
if (!('enrichplot' %in% installed.packages())){BiocManager::install("enrichplot")}
library(enrichplot)
source("C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/go_enrichment.R") # Takes a little time to initialise but adds the function:
OUTPUT <- 'temp/GSE'
DEG_DATA_DIR <- 'C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/DESeq2/Output - Sex V Month Wald/Data'
GENE_MAPPING_FILE <- "C:/Users/cfnsjm/Local Doccuments/PhD/Programming/R/GoEnrichment/joined_gene_info.csv"
SEP <- '\t'
ALPHA <- 0.05
FOLD_CHANGE_CUTOFF <- 1
MIN_NDEG <- 10
SEED <- 1
process_gene_list <- function(gene_list) {
names(gene_list) <- str_replace_all(names(gene_list), regex('gene-'), '')
multiple_homologues_bool <- grepl('_ChrAur', names(gene_list), fixed = TRUE)
multiple_homologues <- names(gene_list)[multiple_homologues_bool]
multiple_homologues <- str_replace_all(multiple_homologues, regex('_ChrAur[0-9]{0,9}'), '')
multiple_homologues <- unique(multiple_homologues)
new_gene_list <- c()
for (homologue in multiple_homologues) {
gene_mean <- c(mean(gene_list[grepl(homologue, names(gene_list), fixed = TRUE)]))
names(gene_mean) <- c(homologue)
new_gene_list <- append(new_gene_list, gene_mean)
}
new_gene_list <- new_gene_list[
new_gene_list > FOLD_CHANGE_CUTOFF | new_gene_list < -FOLD_CHANGE_CUTOFF
]
new_gene_list <- append(new_gene_list, gene_list[!multiple_homologues_bool])
new_gene_list <- new_gene_list[!is.na(new_gene_list)]
return(new_gene_list)
}
gene_list_from_file <- function(file, dir=DEG_DATA_DIR, sep=SEP, universe=FALSE) {
path <- paste(dir, file, sep='/')
df <- read.csv(path, sep=sep)
if (universe) {return(df$gene)}
df <- subset(
df,
df$padj <= ALPHA &
(df$log2FoldChange > FOLD_CHANGE_CUTOFF | df$log2FoldChange < -FOLD_CHANGE_CUTOFF)
)
gene_list <- df$log2FoldChange
names(gene_list) <- df$gene
return(gene_list)
}
modify_duplicates <- function(gene_list) {
for (idx in which(duplicated(gene_list))) {
gene_list[idx] <- gene_list[idx] + 0.000001
}
if (any(duplicated(gene_list))) {
return(modify_duplicates(gene_list))
} else(return(gene_list))
}
if (!file.exists(OUTPUT)) {
dir.create(OUTPUT)
}
saved_wd <- getwd()
setwd(OUTPUT)
gene_mapping_df <- read.csv(GENE_MAPPING_FILE)[,c('X.tax_id', 'Symbol', 'description')]
gene_mapping_df <- gene_mapping_df[order(gene_mapping_df[,'Symbol']),]
gene_mapping_df <- gene_mapping_df[!duplicated(gene_mapping_df$Symbol),]
gene_mapping_df <- subset(gene_mapping_df, !substr(gene_mapping_df$description, 1, 15) == 'uncharacterized')
gene_mapping_df <- subset(gene_mapping_df, !gene_mapping_df$Symbol==gene_mapping_df$description)
gene_mapping <- gene_mapping_df$X.tax_id
names(gene_mapping) <- gene_mapping_df$Symbol
for (file in list.files(DEG_DATA_DIR)) {
print(file)
gene_list <- gene_list_from_file(file, DEG_DATA_DIR, sep=SEP)
go_list <- gene_list
gene_list <- process_gene_list(gene_list)
gene_list <- gene_list[names(gene_list)[names(gene_list) %in% names(gene_mapping)]]
gene_ids <- unname(gene_mapping[names(gene_list)])
names(gene_list) <- gene_ids
if (any(duplicated(gene_list))) {gene_list <- modify_duplicates(gene_list)}
if (any(duplicated(names(gene_list)))) {gene_list <- gene_list[!duplicated(names(gene_list))]}
gene_list <- gene_list[order(gene_list, decreasing=TRUE)]
if (length(gene_list) >= MIN_NDEG) {
go_list <- go_list[order(go_list, decreasing=TRUE)]
go <- gsea(
go_list,
'GO',
title = file,
return_plot = TRUE,
alpha = 0.05
)
gse_kegg <- gseKEGG(
gene_list,
organism = 'dre',
keyType = 'ncbi-geneid',
pvalueCutoff = 0.05,
verbose = FALSE,
seed = SEED,
#universe=gene_list_from_file(file, DEG_DATA_DIR, universe=TRUE)
)
if (!file.exists(substr(file, 1, nchar(file)-4))) {
dir.create(substr(file, 1, nchar(file)-4))
}
setwd(substr(file, 1, nchar(file)-4))
if (!is.null(go)) {try(dev.off(), silent=TRUE); ggsave('GO.png', plot = go)}
gse_kegg@result <- subset(gse_kegg@result, gse_kegg@result$p.adjust < ALPHA)
if (nrow(gse_kegg@result) > 0) {
fig <- dotplot(gse_kegg, showCategory=10, split='.sign') + facet_grid(.~.sign)
ggsave('KEGG_dotplot.png', plot=fig)
}
if (
nrow(gse_kegg@result) > 0 &
length(list.files()) >= 1
) {
for (idx in 1:nrow(gse_kegg@result)) {
row <- gse_kegg[idx,]
print(row$ID)
print(row$setSize)
try(path <- pathview(
gene.data = gene_list,
pathway.id = print(row$ID),
species = "dre",
limit = list(gene=5, cpd=5),
out.suffix = substr(file, 1, nchar(file) - 4)
), silent = TRUE)
}
}
setwd('..')
}
}
q()
